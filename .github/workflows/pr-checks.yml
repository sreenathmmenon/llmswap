name: Pull Request Checks

on:
  pull_request:
    types: [opened, synchronize, reopened, ready_for_review]

jobs:
  # PR Title and Description Check
  pr-lint:
    name: PR Lint
    runs-on: ubuntu-latest
    if: github.event.pull_request.draft == false
    
    steps:
    - name: Check PR title
      run: |
        PR_TITLE="${{ github.event.pull_request.title }}"
        echo "PR Title: $PR_TITLE"
        
        # Check title is not empty
        if [ -z "$PR_TITLE" ]; then
          echo "❌ PR title is empty"
          exit 1
        fi
        
        # Check minimum length
        if [ ${#PR_TITLE} -lt 10 ]; then
          echo "⚠ PR title is very short (< 10 chars)"
        fi
        
        echo "✓ PR title looks good"
    
    - name: Check PR description
      run: |
        PR_BODY="${{ github.event.pull_request.body }}"
        
        if [ -z "$PR_BODY" ]; then
          echo "⚠ PR description is empty. Consider adding context about your changes."
        else
          echo "✓ PR has description (${#PR_BODY} chars)"
        fi
    
    - name: Check for breaking changes
      run: |
        PR_BODY="${{ github.event.pull_request.body }}"
        PR_TITLE="${{ github.event.pull_request.title }}"
        
        if echo "$PR_TITLE" | grep -iq "breaking\|major"; then
          echo "⚠ This PR may contain BREAKING CHANGES"
          echo "Make sure to update CHANGELOG.md and version accordingly"
        fi

  # Check changed files
  changes:
    name: Detect Changes
    runs-on: ubuntu-latest
    outputs:
      core: ${{ steps.filter.outputs.core }}
      web: ${{ steps.filter.outputs.web }}
      tests: ${{ steps.filter.outputs.tests }}
      docs: ${{ steps.filter.outputs.docs }}
    
    steps:
    - uses: actions/checkout@v6
    
    - uses: dorny/paths-filter@v3
      id: filter
      with:
        filters: |
          core:
            - 'llmswap/**/*.py'
            - 'pyproject.toml'
          web:
            - 'llmswap/web/**'
          tests:
            - 'tests/**'
          docs:
            - '**.md'
            - 'docs/**'

  # Run focused tests based on changes
  focused-tests:
    name: Focused Tests
    runs-on: ubuntu-latest
    needs: changes
    
    steps:
    - uses: actions/checkout@v6
    
    - name: Set up Python
      uses: actions/setup-python@v6
      with:
        python-version: "3.11"
        cache: 'pip'
    
    - name: Install dependencies
      run: |
        python -m pip install --upgrade pip
        pip install -e ".[dev]"
    
    - name: Run core tests
      if: needs.changes.outputs.core == 'true'
      run: |
        echo "Running core SDK tests..."
        pytest tests/test_client.py tests/test_providers.py -v
      continue-on-error: true
    
    - name: Run web tests
      if: needs.changes.outputs.web == 'true'
      run: |
        echo "Running web UI tests..."
        pytest tests/test_web.py -v
      continue-on-error: true
    
    - name: Run all tests
      if: needs.changes.outputs.tests == 'true'
      run: |
        echo "Running all tests..."
        pytest tests/ -v
      continue-on-error: true

  # Check compatibility
  compatibility:
    name: Backward Compatibility
    runs-on: ubuntu-latest
    needs: changes
    if: needs.changes.outputs.core == 'true'
    
    steps:
    - uses: actions/checkout@v6
      with:
        fetch-depth: 0
    
    - name: Set up Python
      uses: actions/setup-python@v6
      with:
        python-version: "3.11"
    
    - name: Install dependencies
      run: |
        python -m pip install --upgrade pip
        pip install -e .
    
    - name: Check API compatibility
      run: |
        python << 'EOF'
        import inspect
        from llmswap import LLMClient
        
        # Check critical methods exist
        critical_methods = ['chat', 'set_provider', 'list_available_providers']
        
        for method in critical_methods:
            if hasattr(LLMClient, method):
                print(f"✓ {method} exists")
            else:
                print(f"❌ {method} missing - BREAKING CHANGE!")
                exit(1)
        
        print("\n✓ Backward compatibility maintained")
        EOF

  # Size check
  size-check:
    name: Package Size Check
    runs-on: ubuntu-latest
    
    steps:
    - uses: actions/checkout@v6
    
    - name: Set up Python
      uses: actions/setup-python@v6
      with:
        python-version: "3.11"
    
    - name: Build package
      run: |
        pip install build
        python -m build
    
    - name: Check package size
      run: |
        WHEEL_SIZE=$(stat -f%z dist/*.whl 2>/dev/null || stat -c%s dist/*.whl)
        WHEEL_SIZE_MB=$((WHEEL_SIZE / 1024 / 1024))
        
        echo "Package size: ${WHEEL_SIZE_MB}MB"
        
        if [ $WHEEL_SIZE_MB -gt 50 ]; then
          echo "⚠ Package is larger than 50MB"
        else
          echo "✓ Package size is reasonable"
        fi

  # PR Summary
  summary:
    name: PR Summary
    runs-on: ubuntu-latest
    needs: [pr-lint, changes, focused-tests, compatibility]
    if: always()
    
    steps:
    - name: Generate summary
      run: |
        echo "## PR Check Summary" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        echo "### Changed Areas:" >> $GITHUB_STEP_SUMMARY
        echo "- Core SDK: ${{ needs.changes.outputs.core }}" >> $GITHUB_STEP_SUMMARY
        echo "- Web UI: ${{ needs.changes.outputs.web }}" >> $GITHUB_STEP_SUMMARY
        echo "- Tests: ${{ needs.changes.outputs.tests }}" >> $GITHUB_STEP_SUMMARY
        echo "- Docs: ${{ needs.changes.outputs.docs }}" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        echo "### Test Results:" >> $GITHUB_STEP_SUMMARY
        echo "- Focused tests: ${{ needs.focused-tests.result }}" >> $GITHUB_STEP_SUMMARY
        echo "- Compatibility: ${{ needs.compatibility.result }}" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        echo "✓ PR checks complete" >> $GITHUB_STEP_SUMMARY
